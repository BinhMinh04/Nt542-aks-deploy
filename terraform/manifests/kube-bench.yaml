apiVersion: v1
kind: Secret
metadata:
  name: slack-webhook-secret
  namespace: security
type: Opaque
stringData:
  slack-webhook-url: "https://hooks.slack.com/services/YOUR/WEBHOOK/URL"

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: kube-bench
  namespace: security
  labels:
    app: kube-bench

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: kube-bench-role
rules:
  - apiGroups: [""]
    resources: ["nodes", "pods", "serviceaccounts", "services", "configmaps", "secrets"]
    verbs: ["get", "list", "watch"]
  
  - apiGroups: ["rbac.authorization.k8s.io"]
    resources: ["clusterroles", "clusterrolebindings", "roles", "rolebindings"]
    verbs: ["get", "list", "watch"]
  
  - apiGroups: ["networking.k8s.io"]
    resources: ["networkpolicies"]
    verbs: ["get", "list", "watch"]
  
  - apiGroups: ["policy"]
    resources: ["podsecuritypolicies"]
    verbs: ["get", "list", "watch"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: kube-bench-rolebinding
subjects:
  - kind: ServiceAccount
    name: kube-bench
    namespace: security
roleRef:
  kind: ClusterRole
  name: kube-bench-role
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: kube-bench-scan
  namespace: security
spec:
  schedule: "0 */1 * * *"
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1
  jobTemplate:
    metadata:
      labels:
        app: kube-bench
    spec:
      template:
        metadata:
          labels:
            app: kube-bench
        spec:
          hostPID: true
          nodeSelector:
            kubernetes.io/os: linux
          containers:
          - name: kube-bench
            image: docker.io/aquasec/kube-bench:latest
            command: ["kube-bench"]
            args: 
            - "run"
            - "--targets"
            - "node,policies"
            - "--json"
            - "--outputfile"
            - "/results/output.json"
            - "--alsologtostderr"
            volumeMounts:
            - name: results
              mountPath: /results
            - name: var-lib-kubelet
              mountPath: /var/lib/kubelet
              readOnly: true
            - name: etc-systemd
              mountPath: /etc/systemd
              readOnly: true
            - name: etc-default
              mountPath: /etc/default
              readOnly: true
            - name: etc-kubernetes
              mountPath: /etc/kubernetes
              readOnly: true
              
          - name: slack-alert
            image: alpine/k8s:1.31.2
            command: ["/bin/sh"]
            args:
            - -c
            - |
              set -e
              
              echo "=== Starting CIS Benchmark Report ==="
              
              # Check Secret
              if [ -f "/mnt/secrets/slack-webhook-url" ]; then
                SLACK_WEBHOOK_URL=$(cat /mnt/secrets/slack-webhook-url)
                echo "âœ“ Slack webhook found"
              else
                echo "âœ— Error: Slack webhook secret not found"
                exit 0
              fi

              OUTPUT_FILE="/results/output.json"

              # Wait for Report
              echo "Waiting for kube-bench report..."
              for i in $(seq 1 30); do
                if [ -f "$OUTPUT_FILE" ] && [ -s "$OUTPUT_FILE" ]; then
                  echo "âœ“ Report found!"
                  break
                fi
                echo "  Waiting... ($i/30)"
                sleep 10
              done

              if [ ! -f "$OUTPUT_FILE" ]; then
                echo "âœ— Timeout: Output file not found."
                exit 1
              fi

              sleep 3

              # Parse kube-bench Data
              PASS=$(jq '.Totals.total_pass // 0' "$OUTPUT_FILE")
              FAIL=$(jq '.Totals.total_fail // 0' "$OUTPUT_FILE")
              WARN=$(jq '.Totals.total_warn // 0' "$OUTPUT_FILE")
              SCAN_TIME=$(date '+%Y-%m-%d %H:%M:%S UTC')

              echo ""
              echo "=== Kube-bench Results ==="
              echo "PASS=$PASS, FAIL=$FAIL, WARN=$WARN"

              # Get ALL items
              jq -r '[.Controls[]?.tests[]?.results[]? | select(.status=="PASS")] | .[] | "âœ“ [\(.test_number)] \(.test_desc)"' "$OUTPUT_FILE" > /tmp/passed.txt 2>/dev/null || true
              jq -r '[.Controls[]?.tests[]?.results[]? | select(.status=="FAIL")] | .[] | "âœ— [\(.test_number)] \(.test_desc)"' "$OUTPUT_FILE" > /tmp/failed.txt 2>/dev/null || true
              jq -r '[.Controls[]?.tests[]?.results[]? | select(.status=="WARN")] | .[] | "âš  [\(.test_number)] \(.test_desc)"' "$OUTPUT_FILE" > /tmp/warn.txt 2>/dev/null || true

              PASSED_CONTENT=$(cat /tmp/passed.txt 2>/dev/null)
              FAILED_CONTENT=$(cat /tmp/failed.txt 2>/dev/null)
              WARN_CONTENT=$(cat /tmp/warn.txt 2>/dev/null)

              [ -z "$PASSED_CONTENT" ] && PASSED_CONTENT="None"
              [ -z "$FAILED_CONTENT" ] && FAILED_CONTENT="None"
              [ -z "$WARN_CONTENT" ] && WARN_CONTENT="None"

              # ============================================
              # KYVERNO POLICY TESTS
              # ============================================
              echo ""
              echo "=== Running Kyverno Policy Tests ==="
              
              # Create test namespace
              kubectl create namespace kyverno-test --dry-run=client -o yaml | kubectl apply -f - 2>/dev/null || true
              sleep 2
              
              KYVERNO_RESULTS=""
              KYVERNO_PASS=0
              KYVERNO_FAIL=0

              # Function to test Kyverno policy
              test_kyverno() {
                TEST_ID="$1"
                TEST_NAME="$2"
                shift 2
                
                echo ""
                echo "[$TEST_ID] Testing $TEST_NAME..."
                
                # Run kubectl and capture output
                OUTPUT=$("$@" 2>&1) || true
                echo "  Output: $OUTPUT"
                
                # Check if blocked by Kyverno (not RBAC)
                if echo "$OUTPUT" | grep -qi "disallow-privileged\|disallow-host-pid\|disallow-host-ipc\|disallow-host-network\|disallow-privilege-escalation\|disallow-default-namespace\|policy.*validate\|admission webhook.*denied"; then
                  echo "  âœ… Result: BLOCKED by Kyverno"
                  KYVERNO_RESULTS="${KYVERNO_RESULTS}âœ… [$TEST_ID] $TEST_NAME â†’ BLOCKED by Kyverno
              "
                  KYVERNO_PASS=$((KYVERNO_PASS + 1))
                elif echo "$OUTPUT" | grep -qi "cannot create\|forbidden\|RBAC"; then
                  echo "  âš ï¸ Result: BLOCKED by RBAC (not Kyverno) - need more permissions"
                  KYVERNO_RESULTS="${KYVERNO_RESULTS}âš ï¸ [$TEST_ID] $TEST_NAME â†’ BLOCKED by RBAC (need permissions to test)
              "
                  KYVERNO_FAIL=$((KYVERNO_FAIL + 1))
                elif echo "$OUTPUT" | grep -qi "created\|pod/"; then
                  echo "  âŒ Result: NOT BLOCKED"
                  KYVERNO_RESULTS="${KYVERNO_RESULTS}âŒ [$TEST_ID] $TEST_NAME â†’ NOT BLOCKED
              "
                  KYVERNO_FAIL=$((KYVERNO_FAIL + 1))
                else
                  echo "  â“ Result: Unknown - $OUTPUT"
                  KYVERNO_RESULTS="${KYVERNO_RESULTS}â“ [$TEST_ID] $TEST_NAME â†’ Unknown result
              "
                  KYVERNO_FAIL=$((KYVERNO_FAIL + 1))
                fi
              }

              # Run tests
              test_kyverno "4.2.1" "Privileged containers" \
                kubectl run test-priv-$(date +%s) --image=nginx -n kyverno-test \
                --overrides='{"spec":{"containers":[{"name":"nginx","image":"nginx","securityContext":{"privileged":true}}]}}'

              test_kyverno "4.2.2" "Host PID namespace" \
                kubectl run test-pid-$(date +%s) --image=nginx -n kyverno-test \
                --overrides='{"spec":{"hostPID":true,"containers":[{"name":"nginx","image":"nginx"}]}}'

              test_kyverno "4.2.3" "Host IPC namespace" \
                kubectl run test-ipc-$(date +%s) --image=nginx -n kyverno-test \
                --overrides='{"spec":{"hostIPC":true,"containers":[{"name":"nginx","image":"nginx"}]}}'

              test_kyverno "4.2.4" "Host Network namespace" \
                kubectl run test-net-$(date +%s) --image=nginx -n kyverno-test \
                --overrides='{"spec":{"hostNetwork":true,"containers":[{"name":"nginx","image":"nginx"}]}}'

              test_kyverno "4.2.5" "Privilege Escalation" \
                kubectl run test-esc-$(date +%s) --image=nginx -n kyverno-test \
                --overrides='{"spec":{"containers":[{"name":"nginx","image":"nginx","securityContext":{"allowPrivilegeEscalation":true}}]}}'

              test_kyverno "4.6.3" "Default namespace usage" \
                kubectl run test-def-$(date +%s) --image=nginx -n default

              # Cleanup
              echo ""
              echo "Cleaning up..."
              kubectl delete namespace kyverno-test --ignore-not-found --wait=false 2>/dev/null &
              kubectl delete pod -n default -l run --ignore-not-found --wait=false 2>/dev/null &

              echo ""
              echo "=== Kyverno Summary: PASS=$KYVERNO_PASS, FAIL=$KYVERNO_FAIL ==="

              # ============================================
              # SEND TO SLACK
              # ============================================
              echo ""
              echo "=== Sending to Slack ==="
              
              # Message 1: Summary
              jq -n \
                --arg time "$SCAN_TIME" \
                --arg pass "$PASS" \
                --arg fail "$FAIL" \
                --arg warn "$WARN" \
              '{
                "blocks": [
                  {"type": "header", "text": {"type": "plain_text", "text": "ðŸ” CIS AKS Benchmark Report", "emoji": true}},
                  {"type": "section", "fields": [{"type": "mrkdwn", "text": ("*Target:* Node & Policies\n*Time:* " + $time)}]},
                  {"type": "divider"},
                  {"type": "section", "fields": [
                    {"type": "mrkdwn", "text": ("âœ… *Pass:* " + $pass)},
                    {"type": "mrkdwn", "text": ("âŒ *Fail:* " + $fail)},
                    {"type": "mrkdwn", "text": ("âš ï¸ *Warn:* " + $warn)}
                  ]}
                ]
              }' > /tmp/msg1.json

              # Message 2: All Passed
              jq -n --arg passed "$PASSED_CONTENT" \
              '{
                "blocks": [
                  {"type": "divider"},
                  {"type": "section", "text": {"type": "mrkdwn", "text": "*âœ… All Passed Checks:*"}},
                  {"type": "section", "text": {"type": "mrkdwn", "text": ("```" + $passed + "```")}}
                ]
              }' > /tmp/msg2.json

              # Message 3: Failed
              jq -n --arg failed "$FAILED_CONTENT" \
              '{
                "blocks": [
                  {"type": "divider"},
                  {"type": "section", "text": {"type": "mrkdwn", "text": "*âŒ Failed Checks:*"}},
                  {"type": "section", "text": {"type": "mrkdwn", "text": ("```" + $failed + "```")}}
                ]
              }' > /tmp/msg3.json

              # Message 4: Warnings
              jq -n --arg warnings "$WARN_CONTENT" \
              '{
                "blocks": [
                  {"type": "divider"},
                  {"type": "section", "text": {"type": "mrkdwn", "text": "*âš ï¸ Warnings:*"}},
                  {"type": "section", "text": {"type": "mrkdwn", "text": ("```" + $warnings + "```")}}
                ]
              }' > /tmp/msg4.json

              # Message 5: Kyverno Tests
              jq -n \
                --arg kpass "$KYVERNO_PASS" \
                --arg kfail "$KYVERNO_FAIL" \
                --arg results "$KYVERNO_RESULTS" \
              '{
                "blocks": [
                  {"type": "divider"},
                  {"type": "header", "text": {"type": "plain_text", "text": "ðŸ›¡ï¸ Kyverno Policy Enforcement Test", "emoji": true}},
                  {"type": "section", "text": {"type": "mrkdwn", "text": "_Testing if Kyverno blocks policy violations for user workloads..._"}},
                  {"type": "section", "fields": [
                    {"type": "mrkdwn", "text": ("âœ… *Blocked:* " + $kpass + "/6")},
                    {"type": "mrkdwn", "text": ("âš ï¸ *Other:* " + $kfail + "/6")}
                  ]},
                  {"type": "section", "text": {"type": "mrkdwn", "text": ("```" + $results + "```")}},
                  {"type": "context", "elements": [{"type": "mrkdwn", "text": "â„¹ï¸ Kube-bench failures are from *system pods* (kube-system, calico) which need elevated privileges. *User workloads ARE protected* by Kyverno."}]}
                ]
              }' > /tmp/msg5.json

              # Send messages
              echo "Sending message 1 (Summary)..."
              curl -sf -X POST "$SLACK_WEBHOOK_URL" -H 'Content-type: application/json' -d @/tmp/msg1.json && echo " âœ“" || echo " âœ—"
              sleep 1
              
              echo "Sending message 2 (Passed)..."
              curl -sf -X POST "$SLACK_WEBHOOK_URL" -H 'Content-type: application/json' -d @/tmp/msg2.json && echo " âœ“" || echo " âœ—"
              sleep 1
              
              if [ "$FAIL" != "0" ]; then
                echo "Sending message 3 (Failed)..."
                curl -sf -X POST "$SLACK_WEBHOOK_URL" -H 'Content-type: application/json' -d @/tmp/msg3.json && echo " âœ“" || echo " âœ—"
                sleep 1
              fi
              
              if [ "$WARN" != "0" ]; then
                echo "Sending message 4 (Warnings)..."
                curl -sf -X POST "$SLACK_WEBHOOK_URL" -H 'Content-type: application/json' -d @/tmp/msg4.json && echo " âœ“" || echo " âœ—"
                sleep 1
              fi
              
              echo "Sending message 5 (Kyverno)..."
              curl -sf -X POST "$SLACK_WEBHOOK_URL" -H 'Content-type: application/json' -d @/tmp/msg5.json && echo " âœ“" || echo " âœ—"
              
              echo ""
              echo "=== Done ==="
            volumeMounts:
            - name: results
              mountPath: /results
            - name: secrets
              mountPath: /mnt/secrets
              readOnly: true

          volumes:
          - name: results
            emptyDir: {}
          - name: secrets
            secret:
              secretName: slack-webhook-secret
          - name: var-lib-kubelet
            hostPath:
              path: "/var/lib/kubelet"
          - name: etc-systemd
            hostPath:
              path: "/etc/systemd"
          - name: etc-default
            hostPath:
              path: "/etc/default"
          - name: etc-kubernetes
            hostPath:
              path: "/etc/kubernetes"
          
          restartPolicy: OnFailure
          serviceAccountName: kube-bench
