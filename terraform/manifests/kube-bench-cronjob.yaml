apiVersion: batch/v1
kind: CronJob
metadata:
  name: kube-bench-scan
  namespace: security
spec:
  schedule: "0 */1 * * *"
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1
  jobTemplate:
    metadata:
      labels:
        app: kube-bench
    spec:
      template:
        metadata:
          labels:
            app: kube-bench
        spec:
          hostPID: true
          nodeSelector:
            kubernetes.io/os: linux
          containers:
          - name: kube-bench
            image: docker.io/aquasec/kube-bench:latest
            command: ["kube-bench"]
            args: 
            - "run"
            - "--targets"
            - "node,policies"
            - "--json"
            - "--outputfile"
            - "/results/output.json"
            - "--alsologtostderr"
            volumeMounts:
            - name: results
              mountPath: /results
            - name: var-lib-kubelet
              mountPath: /var/lib/kubelet
              readOnly: true
            - name: etc-systemd
              mountPath: /etc/systemd
              readOnly: true
            - name: etc-default
              mountPath: /etc/default
              readOnly: true
            - name: etc-kubernetes
              mountPath: /etc/kubernetes
              readOnly: true
              
          - name: slack-alert
            image: alpine:3.18
            command: ["/bin/sh", "-c"]
            args:
            - |
              apk add --no-cache curl jq
              
              # 1. Check Secret
              if [ -f "/mnt/secrets/slack-webhook-url" ]; then
                SLACK_WEBHOOK_URL=$(cat /mnt/secrets/slack-webhook-url)
              else
                echo "Error: Slack webhook secret not found"
                exit 0
              fi

              OUTPUT_FILE="/results/output.json"
              
              # 2. Wait for Report
              echo "Waiting for kube-bench report..."
              for i in $(seq 1 18); do
                if [ -f "$OUTPUT_FILE" ]; then
                  echo "Report found!"
                  break
                fi
                echo "Waiting... ($i/18)"
                sleep 10
              done

              if [ ! -f "$OUTPUT_FILE" ]; then
                echo "Timeout: Output file not found."
                exit 1
              fi
              
              sleep 5

              # 3. Parse Data using jq
              PASS=$(jq '.Totals.total_pass // 0' $OUTPUT_FILE)
              FAIL=$(jq '.Totals.total_fail // 0' $OUTPUT_FILE)
              WARN=$(jq '.Totals.total_warn // 0' $OUTPUT_FILE)
              
              # Get current time
              SCAN_TIME=$(date '+%Y-%m-%d %H:%M:%S UTC')
              
              # Get failed items list
              FAILURES=$(jq -r '
                [.Controls[]?.tests[]?.results[]? | select(.status=="FAIL")] 
                | .[0:15] 
                | .[] 
                | "‚Ä¢ [\(.test_number)] \(.test_desc)"
              ' $OUTPUT_FILE 2>/dev/null || echo "")

              # 4. Build Slack Block Kit message (much better formatting)
              if [ "$FAIL" != "0" ] && [ -n "$FAILURES" ]; then
                # Has failures - create detailed message
                PAYLOAD=$(jq -n \
                  --arg pass "$PASS" \
                  --arg fail "$FAIL" \
                  --arg warn "$WARN" \
                  --arg time "$SCAN_TIME" \
                  --arg failures "$FAILURES" \
                  '{
                    "blocks": [
                      {
                        "type": "header",
                        "text": {
                          "type": "plain_text",
                          "text": "üîç CIS AKS Benchmark Report",
                          "emoji": true
                        }
                      },
                      {
                        "type": "section",
                        "fields": [
                          {
                            "type": "mrkdwn",
                            "text": "*Target:*\nNode & Policies"
                          },
                          {
                            "type": "mrkdwn",
                            "text": ("*Scan Time:*\n" + $time)
                          }
                        ]
                      },
                      {
                        "type": "divider"
                      },
                      {
                        "type": "section",
                        "text": {
                          "type": "mrkdwn",
                          "text": "*üìä Summary*"
                        }
                      },
                      {
                        "type": "section",
                        "fields": [
                          {
                            "type": "mrkdwn",
                            "text": ("‚úÖ *Pass:* " + $pass)
                          },
                          {
                            "type": "mrkdwn",
                            "text": ("‚ùå *Fail:* " + $fail)
                          },
                          {
                            "type": "mrkdwn",
                            "text": ("‚ö†Ô∏è *Warn:* " + $warn)
                          }
                        ]
                      },
                      {
                        "type": "divider"
                      },
                      {
                        "type": "section",
                        "text": {
                          "type": "mrkdwn",
                          "text": "*‚ùå Failed Items (Top 15):*"
                        }
                      },
                      {
                        "type": "section",
                        "text": {
                          "type": "mrkdwn",
                          "text": ("```" + $failures + "```")
                        }
                      }
                    ]
                  }')
              else
                # No failures - success message
                PAYLOAD=$(jq -n \
                  --arg pass "$PASS" \
                  --arg fail "$FAIL" \
                  --arg warn "$WARN" \
                  --arg time "$SCAN_TIME" \
                  '{
                    "blocks": [
                      {
                        "type": "header",
                        "text": {
                          "type": "plain_text",
                          "text": "üîç CIS AKS Benchmark Report",
                          "emoji": true
                        }
                      },
                      {
                        "type": "section",
                        "fields": [
                          {
                            "type": "mrkdwn",
                            "text": "*Target:*\nNode & Policies"
                          },
                          {
                            "type": "mrkdwn",
                            "text": ("*Scan Time:*\n" + $time)
                          }
                        ]
                      },
                      {
                        "type": "divider"
                      },
                      {
                        "type": "section",
                        "text": {
                          "type": "mrkdwn",
                          "text": "*üìä Summary*"
                        }
                      },
                      {
                        "type": "section",
                        "fields": [
                          {
                            "type": "mrkdwn",
                            "text": ("‚úÖ *Pass:* " + $pass)
                          },
                          {
                            "type": "mrkdwn",
                            "text": ("‚ùå *Fail:* " + $fail)
                          },
                          {
                            "type": "mrkdwn",
                            "text": ("‚ö†Ô∏è *Warn:* " + $warn)
                          }
                        ]
                      },
                      {
                        "type": "divider"
                      },
                      {
                        "type": "section",
                        "text": {
                          "type": "mrkdwn",
                          "text": "üéâ *Excellent! No critical failures detected.*"
                        }
                      }
                    ]
                  }')
              fi

              # 5. Send to Slack
              if [ -n "$SLACK_WEBHOOK_URL" ]; then
                echo "Sending to Slack..."
                echo "$PAYLOAD" > /tmp/payload.json
                
                HTTP_CODE=$(curl -s -o /tmp/response.txt -w "%{http_code}" \
                  -X POST "$SLACK_WEBHOOK_URL" \
                  -H 'Content-type: application/json' \
                  -d "$PAYLOAD")
                
                if [ "$HTTP_CODE" = "200" ]; then
                  echo "‚úÖ Successfully sent to Slack!"
                else
                  echo "‚ùå Failed to send. HTTP Code: $HTTP_CODE"
                  cat /tmp/response.txt
                fi
              fi
            volumeMounts:
            - name: results
              mountPath: /results
            - name: secrets
              mountPath: /mnt/secrets
              readOnly: true

          volumes:
          - name: results
            emptyDir: {}
          - name: secrets
            secret:
              secretName: slack-webhook-secret
          - name: var-lib-kubelet
            hostPath:
              path: "/var/lib/kubelet"
          - name: etc-systemd
            hostPath:
              path: "/etc/systemd"
          - name: etc-default
            hostPath:
              path: "/etc/default"
          - name: etc-kubernetes
            hostPath:
              path: "/etc/kubernetes"
          
          restartPolicy: OnFailure
          serviceAccountName: kube-bench
